<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-selector/iron-selectable.html">

<!--
`step-slideshow`

@demo step-slideshow/demo/index.html
-->

<dom-module id="step-slideshow">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        overflow: hidden;
      }
      #slider {
        @apply --layout-horizontal;
      }
      #slider > ::slotted(*) {
        min-width: 100%;
        opacity: 0;
      }
      #slider > ::slotted(*.neon-selected:not(.neon-animating)) {
        opacity: 1;
      }
      #slider > ::slotted(*:not(.neon-selected):not(.neon-animating)) {
        display: none !important;
      }
    </style>

    <div id="slider">
      <slot></slot>
    </div>

  </template>
  <script>

    Polymer({

      is: 'step-slideshow',

      behaviors: [
        Polymer.IronResizableBehavior
      ],

      properties: {
        selectedStep: {
          type: Object
        }
      },

      observers: [
        '_selectedStepChanged(selectedStep)'
      ],

      currentStep: null,

      slideAnimation: null,

      _selectedStepChanged(selectedStep) {
        // Use a debouncer because the selectedItem is undefined between every change.
        // See https://github.com/PolymerElements/iron-selector/issues/118
        this.debounce('selected-step-changed', function() {

          if (!selectedStep) {
            this.currentStep = null;
            return;
          }

          var previousStep = this.currentStep;

          selectedStep.classList.add('neon-selected');
          selectedStep.notifyResize();
          if (previousStep) {
            previousStep.classList.remove('neon-selected');
          }

          this.currentStep = selectedStep;

          if (!HTMLElement.prototype.animate) return;

          if (this.slideAnimation) {
            this.slideAnimation.cancel();
          }

          if (previousStep) {
            var startXTranslate = 0, endXTranslate = 0;

            // If right direction
            if (previousStep.index - selectedStep.index > 0) {
              startXTranslate = -100;
            } else {
              endXTranslate = -100;
            }
            var opacityTiming = {duration: 300};
            selectedStep.animate([
              {opacity: 0},
              {opacity: 1}
            ], {duration: 300, delay: 200})
            previousStep.animate([
              {opacity: 1},
              {opacity: 0}
            ], {duration: 300})

            selectedStep.classList.add('neon-animating');
            previousStep.classList.add('neon-animating');

            this.slideAnimation = this.$.slider.animate([
              { transform: 'translateX(' + startXTranslate + '%)' },
              { transform: 'translateX(' + endXTranslate + '%)' }
            ], {
              duration: 500,
              easing: 'ease-in-out'
            });

            this.slideAnimation.onfinish = () => {
              selectedStep.classList.remove('neon-animating');
              previousStep.classList.remove('neon-animating');
            }
          }

        }.bind(this), 1);
      }

    });

  </script>
</dom-module>
