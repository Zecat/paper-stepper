<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-selector/iron-selectable.html">

<script>

window.Stepper = window.Stepper || {};

  /*
  * @polymerBehavior Stepper.PaperStepperBehavior
  */
  Stepper.PaperStepperBehaviorImpl = {

    properties: {
      selectedAttribute: {
        value: 'opened',
        readOnly: true
      },
    },

    /**
     * Loops around the steps from the current (if no step opened, from the first one)
     * in order to open the next selectable unsaved step. Returns true if a step has been opened.
     */
    progress: function() {
      if (!this.items || !this.items.length) {
        return false;
      }

      var
        stepNumber = this.items.length,
        selectedIndex = this.indexOf(this.selectedItem),
        item,
        nextEditableStepIndex;

      for (var i = (selectedIndex+1)%stepNumber; i != selectedIndex; i = (i+1)%stepNumber) {
        item = this.items[i];
        if (item.disabled) break;
        if (!item.saved) {
          this.selectIndex(i);
          this.fire('paper-stepper-progress');
          return true;
        } else if (item.editable && nextEditableStepIndex === undefined) {
          nextEditableStepIndex = i;
        }
      }

      if (nextEditableStepIndex !== undefined) {
        this.selectIndex(nextEditableStepIndex);
        this.fire('paper-stepper-progress');
        return true;
      }

      return false;
    },


    /**
     * Work around: Override the method from IronSelectableBehavior to only
     * allow the selection of selectable step.
     * See https://github.com/PolymerElements/iron-selector/issues/99
     */
    _selectSelected: function(selected) {
      if (!this.items) {
        return;
      }
      var item = this._valueToItem(this.selected), disabled = item && item.disabled;
      if (disabled) {
        // Reset previous selected if defined and not disabled or deselect
        this.selected = this._previousSelected && !this._previousSelected.disabled ?
          this._valueForItem(this.previousSelected) : null;
        this._previousSelected = null;
      } else {
        if (item) {
          this._selection.select(item);
        } else {
          this._selection.clear();
        }
        this._previousSelected = item;
      }
      // Check for items, since this array is populated only when attached
      // Since Number(0) is falsy, explicitly check for undefined
      if (this.fallbackSelection && this.items.length && (this._selection.get() === undefined)) {
        var fallbackItem = this._valueToItem(this.fallbackSelection);
        if (!fallbackItem.disabled) {
          this.selected = this.fallbackSelection;
        }
      }
    },

  };

    /** @polymerBehavior */
  Stepper.PaperStepperBehavior = [
    Polymer.IronSelectableBehavior,
    Stepper.PaperStepperBehaviorImpl
  ];
</script>
