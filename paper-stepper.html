<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="paper-step.html">
<link rel="import" href="paper-stepper-behavior.html">
<link rel="import" href="paper-horizontal-labels-container.html">
<link rel="import" href="paper-vertical-steps-container.html">

<!--
Missing Doc


## Styling

The default color values respect the material specifications. For basic configuration, just defines the `--primary-color` for your app.

The stepper has a complexe interface so many custom properties are available, use them this way :

```html
<style is="custom-style">

  paper-stepper {
    --paper-stepper-custom-property: value;
  }

  paper-step {
    --paper-step-custom-property: value;
  }

</style>

<paper-stepper>
  <paper-step></paper-step>
  <paper-step></paper-step>
</paper-stepper>
```

Note, for sizing the stepper and steps depending on the layout, use the following instead of setting 'height' and 'max-height' :
- `--paper-stepper-horizontal-opened-height`
- `--paper-stepper-vertical-max-height`
- `--paper-vertical-step-max-height`

### Stepper

Custom property | Description | Default
------|-------------|----------
`--paper-stepper-horizontal-opened-height` | The horizontal opened stepper height | 450px
`--paper-stepper-horizontal-opening-transition-duration`| The horizontal stepper opening transition duration (ms) | 500
`--paper-stepper-vertical-max-height`| The vertical stepper max height so it has a scrollable area | undefined

### Step

Custom property | Description | Default
------|-------------|----------
`--paper-step-connector-line-background` | The connector lines background color. | `--divider-color`
`--paper-step-label-hover-background` | The steps label background when hovered. | rgba(0,0,0,0.04)
`--paper-step-ink-color` | The steps ripple effect ink color. | `--divider-color`

### Step text label

Custom property | Description | Default
------|-------------|----------
`--paper-step-disabled-label-text-color` | The no-selectable steps label text color. | `--paper-grey-400`
`--paper-step-selectable-label-text-color` | The selectable steps label text color. | `--paper-grey-600`
`--paper-step-opened-label-text-color` | The opened steps label text color. | `--light-theme-text-color`
`--paper-step-label-text-font-size` | The steps label text font size. | 14px
`--paper-step-label-optional-text-font-size` | The steps label optional text font size. | 12px

### Step badge

Custom property | Description | Default
------|-------------|----------
`--paper-step-badge-background` | The badge background. | `--paper-grey-300`
`--paper-step-badge-color` | The badge color. | `--dark-theme-text-color`
`--paper-step-badge-icon-width` | The badge icon width. | 16px
`--paper-step-badge-icon-height` | The badge icon height. | 16px
`--paper-step-opened-badge-background` | The opened steps badge background. | `--primary-color`
`--paper-step-saved-badge-background` | The saved steps badge background. | `--primary-color`
`--paper-step-selectable-hovered-badge-background` | The no-opened no-saved selectable steps badge background. | `--paper-grey-500`

### Vertical step

Custom property | Description | Default
------|-------------|----------
`--paper-vertical-step-continue-button-background` | The continue button background. | `--primary-color`
`--paper-vertical-step-continue-button-color` | The continue button background. | `--dark-theme-text-color`
`--paper-vertical-step-max-height` | The unrolled step content max-height. | 400px
`--paper-vertical-step-transition-duration` | The step opening transition duration | 500ms


@element paper-stepper
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="paper-stepper">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }
      #verticalResponsiveWidth {
        width: var(--paper-stepper-vertical-responsive-width, 0px);
        visibility: hidden;
      }
      [hidden] {
        display: none !important;
      }
    </style>

    <!-- Hidden block with width equals to the responsive threshold -->
    <div id="verticalResponsiveWidth"></div>

    <template is="dom-if" if="[[!vertical]]" on-dom-change="_handleHorizontalDomChange">

      <paper-horizontal-labels-container
        id="horizontalLabelsContainer"
        selected="{{selected}}"
        selected-attribute="opened"
        attr-for-selected="[[attrForSelected]]"
        alternative-label="{{alternativeLabel}}"
      >
        <slot name="horizontal-step-label-template"></slot>
      </paper-horizontal-labels-container>

      <slot
        id="horizontalStepsContainerTemplateSlot"
        name="horizontal-steps-container-template"
      >
        <template>
          <iron-pages
            selected="{{selected}}"
            attr-for-selected="[[attrForSelected]]"
          ></iron-pages>
        </template>
      </slot>

    </template>

    <template is="dom-if" if="[[vertical]]" on-dom-change="_handleVerticalDomChange">

      <paper-vertical-steps-container
        id="verticalStepsContainer"
        selectable="step-vertical-label"
      >
        <slot
          name="vertical-step-label-template"
          slot="vertical-step-label-template"
        ></slot>
        <slot
          name="vertical-step-wrapper-template"
          slot="vertical-step-wrapper-template"
        ></slot>
      </paper-vertical-steps-container>

    </template>

  </template>

  <script>
    'use strict';
    Polymer({

      is: 'paper-stepper',

      behaviors: [
        Stepper.PaperStepperBehavior,
        Polymer.IronResizableBehavior,
        Polymer.Templatizer
      ],

      /**
       * Fired when the stepper progress.
       *
       * @event paper-stepper-progressed
       */
      /**
       * Fired when all the steps are saved.
       *
       * @event paper-stepper-completed
       */
      properties: {
        alternativeLabel: {
          type: Boolean,
          value: false
        },
        vertical: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true
        },
        responsiveCheckFrequence: {
          type: Number,
          value: 200
        },
        activateEvent: {
          type: String,
          value: 'paper-step-select'
        },
        stepsSlotContainer: {
          type: HTMLElement,
          computed: '_computeStepsSlotContainer(horizontalStepsContainer, verticalStepsContainer, vertical)'
        },
        stepsSlot: {
          type: HTMLElement,
          value: function() {
            return this.createSlot();
          }
        },
        horizontalLabelsContainer: {
          type: HTMLElement,
          computed: '_computeHorizontalLabelsContainer(_horizontalDomStamped)'
        },
        horizontalStepsContainer: {
          type: HTMLElement,
          computed: '_computeHorizontalStepsContainer(_horizontalDomStamped)'
        },
        verticalStepsContainer: {
          type: HTMLElement,
          computed: '_computeVerticalStepsContainer(_verticalDomStamped)'
        },
        _horizontalDomStamped: {
          type: Boolean,
          value: false
        },
        _verticalDomStamped: {
          type: Boolean,
          value: false
        }
      },

      _previousSelected: null,

      listeners:Â {
        'iron-items-changed': '_ironItemsChanged',
        'iron-resize': '_resizeHandler',
        'paper-stepper-forward': 'skip',
        'paper-stepper-back': 'back',
        'paper-stepper-continue': 'continue',
        'iron-activate' : '_handleIronActivate'
      },

      _handleIronActivate(e) {
        // If the step is disabled
        if (e.detail.item.disabled) {
          // Prevent selection
          e.preventDefault();
        }
      },

      observers: [
        '_updateHorizontalStepsLabel(horizontalLabelsContainer, vertical, items)',
        '_updateStepsSlotParent(stepsSlot, stepsSlotContainer)'
      ],

      attached: function() {
        this._responsiveCheck();
      },

      _handleHorizontalDomChange: function() {
        if (!this.vertical) {
          this._horizontalDomStamped = true;
        }
      },

      _handleVerticalDomChange: function() {
        if (this.vertical) {
          this._verticalDomStamped = true;
        }
      },

      _computeStepsSlotContainer: function(horizontalStepsContainer, verticalStepsContainer, vertical) {
        return vertical ? verticalStepsContainer : horizontalStepsContainer;
      },

      _computeHorizontalLabelsContainer: function(_horizontalDomStamped) {
        return _horizontalDomStamped ?
          this.$$('#horizontalLabelsContainer') : null;
      },

      _computeHorizontalStepsContainer: function(_horizontalDomStamped) {
        return _horizontalDomStamped ?
          this._appendHorizontalStepsContainer() : null;
      },

      _computeVerticalStepsContainer: function(_verticalDomStamped) {
        return _verticalDomStamped ?
          this.$$('#verticalStepsContainer') : null;
      },

      _updateHorizontalStepsLabel(horizontalLabelsContainer, vertical, items) {
        if (!horizontalLabelsContainer || !items || vertical == null) return;
        if (!vertical) {
          horizontalLabelsContainer.steps = items;
        } else if (horizontalLabelsContainer.steps) {
          horizontalLabelsContainer.steps = [];
        }
      },

      _updateStepsSlotParent(stepsSlot, stepsSlotContainer) {
        if (stepsSlotContainer && stepsSlot) {
          this.items.forEach(function(item) {
            item.slot = "";
          });
          Polymer.dom(stepsSlotContainer).appendChild(stepsSlot);
        }
      },
      _appendHorizontalStepsContainer() {
        Polymer.dom.flush();
        var stepsContainerTemplate = this.getContentChildren('#horizontalStepsContainerTemplateSlot')[0];
        // TODO: check for template to be valid
        this.templatize(stepsContainerTemplate);
        var stamped = this.stamp();
        Polymer.dom(this.root).appendChild(stamped.root);
        return Polymer.Element ? stamped.root.nodeList[0] : stamped._nodes[0];
      },

      createSlot: function(name) {
        var slot;
        if (Polymer.Element) {
          slot = document.createElement('slot');
          if (name) slot.setAttribute('name', name);
        } else {
          slot = document.createElement('content');
          if (name) slot.setAttribute('select', "[slot='" + name + "']");
        }
        return slot;
      },

      _ironItemsChanged: function(e) {
        // Ingore events comming from nested childrens
        if (Polymer.dom(e).rootTarget != this) return;
        // Set the steps index
        // TODO: Could be done more efficiently by listening added and removed steps
        this.items.forEach(function(step, i) {
            step._setIndex(i + 1);
        });
      },

      _resizeHandler: function() {
        this.debounce('paper-stepper-responsive-check', function() {
          this._responsiveCheck();
        }, this.responsiveCheckFrequence);
      },

      _responsiveCheck: function() {
        var verticalResponsiveWidth = this.$.verticalResponsiveWidth.clientWidth;
        if (verticalResponsiveWidth) {
          this.vertical = !(this.clientWidth > verticalResponsiveWidth);
        }
      }

    });

  </script>
</dom-module>
