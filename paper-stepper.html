<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-selector/iron-selectable.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-styles/default-theme.html">
<link rel="import" href="../paper-styles/shadow.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="paper-step.html">
<link rel="import" href="paper-horizontal-labels-container.html">
<link rel="import" href="paper-vertical-steps-container.html">
<link rel="import" href="step-horizontal-label.html">
<link rel="import" href="step-vertical-label.html">

<!--
Missing Doc


## Styling

The default color values respect the material specifications. For basic configuration, just defines the `--primary-color` for your app.

The stepper has a complexe interface so many custom properties are available, use them this way :

```html
<style is="custom-style">

  paper-stepper {
    --paper-stepper-custom-property: value;
  }

  paper-step {
    --paper-step-custom-property: value;
  }

</style>

<paper-stepper>
  <paper-step></paper-step>
  <paper-step></paper-step>
</paper-stepper>
```

Note, for sizing the stepper and steps depending on the layout, use the following instead of setting 'height' and 'max-height' :
- `--paper-stepper-horizontal-opened-height`
- `--paper-stepper-vertical-max-height`
- `--paper-vertical-step-max-height`

### Stepper

Custom property | Description | Default
------|-------------|----------
`--paper-stepper-horizontal-opened-height` | The horizontal opened stepper height | 450px
`--paper-stepper-horizontal-opening-transition-duration`| The horizontal stepper opening transition duration (ms) | 500
`--paper-stepper-vertical-max-height`| The vertical stepper max height so it has a scrollable area | undefined

### Step

Custom property | Description | Default
------|-------------|----------
`--paper-step-connector-line-background` | The connector lines background color. | `--divider-color`
`--paper-step-label-hover-background` | The steps label background when hovered. | rgba(0,0,0,0.04)
`--paper-step-ink-color` | The steps ripple effect ink color. | `--divider-color`

### Step text label

Custom property | Description | Default
------|-------------|----------
`--paper-step-disabled-label-text-color` | The no-selectable steps label text color. | `--paper-grey-400`
`--paper-step-selectable-label-text-color` | The selectable steps label text color. | `--paper-grey-600`
`--paper-step-opened-label-text-color` | The opened steps label text color. | `--light-theme-text-color`
`--paper-step-label-text-font-size` | The steps label text font size. | 14px
`--paper-step-label-optional-text-font-size` | The steps label optional text font size. | 12px

### Step badge

Custom property | Description | Default
------|-------------|----------
`--paper-step-badge-background` | The badge background. | `--paper-grey-300`
`--paper-step-badge-color` | The badge color. | `--dark-theme-text-color`
`--paper-step-badge-icon-width` | The badge icon width. | 16px
`--paper-step-badge-icon-height` | The badge icon height. | 16px
`--paper-step-opened-badge-background` | The opened steps badge background. | `--primary-color`
`--paper-step-saved-badge-background` | The saved steps badge background. | `--primary-color`
`--paper-step-selectable-hovered-badge-background` | The no-opened no-saved selectable steps badge background. | `--paper-grey-500`

### Vertical step

Custom property | Description | Default
------|-------------|----------
`--paper-vertical-step-continue-button-background` | The continue button background. | `--primary-color`
`--paper-vertical-step-continue-button-color` | The continue button background. | `--dark-theme-text-color`
`--paper-vertical-step-max-height` | The unrolled step content max-height. | 400px
`--paper-vertical-step-transition-duration` | The step opening transition duration | 500ms


@element paper-stepper
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="paper-stepper">
  <template strip-whitespace>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }
      #verticalResponsiveWidth {
        width: var(--paper-stepper-vertical-responsive-width, 0px);
        visibility: hidden;
      }
      /*:host([vertical]) {
        padding: 4px 0;
        @apply(--layout-scroll);
        max-height: var(--paper-stepper-vertical-max-height);
      }*/
      [hidden] {
        display: none !important;
      }
      #verticalStepsContainer {
        @apply --layout-vertical;
      }
    </style>

    <slot
      id="horizontalStepLabelTemplateSlot"
      name="horizontal-step-label-template"
    >
      <template>
        <step-horizontal-label
          editable="{{editable}}"
          label="{{label}}"
          optional="[[optional]]"
          opened$="{{opened}}"
          selectable="[[selectable]]"
          index="{{index}}"
          saved="{{saved}}"
          disabled="[[disabled]]"
          step="[[step]]"
        ></step-horizontal-label>
      </template>
    </slot>

    <slot
      id="verticalStepLabelTemplateSlot"
      name="vertical-step-label-template"
    >
      <template>
        <step-vertical-label
          editable="{{editable}}"
          label="{{label}}"
          optional="[[optional]]"
          opened$="{{opened}}"
          selectable="[[selectable]]"
          index="{{index}}"
          saved="{{saved}}"
          disabled="[[disabled]]"
          step="[[step]]"
        ></step-vertical-label>
      </template>
    </slot>

    <!-- Hidden block with width equals to the responsive threshold -->
    <div id="verticalResponsiveWidth"></div>

    <paper-horizontal-labels-container
      id="horizontalLabelsContainer"
      hidden$="[[vertical]]"
      selected-attribute="opened"
      on-iron-select="_handleHorizontalLabelsSelect"
    ></paper-horizontal-labels-container>

    <slot
      id="horizontalStepsContainerTemplateSlot"
      name="horizontal-steps-container-template"
    >
      <template>
        <iron-pages selected="{{selected}}"></iron-pages>
      </template>
    </slot>

    <paper-vertical-steps-container
      id="verticalStepsContainer"
      selectable="step-vertical-label"
      hidden$="[[!vertical]]"
    >
    </paper-vertical-steps-container>
    <!-- <paper-listbox
      id="verticalStepsContainer"
      hidden$="[[!vertical]]"
      selectable="step-vertical-label"
    >
      <slot name="vertical-step-0"></slot>
      <slot name="vertical-step-1"></slot>
      <h2>TTTTT</h2>
      <slot name="vertical-step-2"></slot>
    </paper-listbox> -->

    <!-- <paper-vertical-steps-container
      id="paperVerticalStepsContainer"
      hidden$="[[!vertical]]"
    >

    </paper-vertical-steps-container> -->

<div hidden$="[[vertical]]">

    <!-- TODO: create the slot dynamically -->
    <slot id="stepsSlot"></slot>
  </div>



    <!-- <template is="dom-if" id="[[!vertical]]"> -->
      <!-- <iron-pages selected="{{selected}}">
        <slot></slot>
      </iron-pages> -->
    <!-- </template> -->

    <!-- <slot></slot> -->


  </template>

  <script>
    'use strict';
    Polymer({

      is: 'paper-stepper',

      behaviors: [
        Polymer.IronResizableBehavior,
        Polymer.IronSelectableBehavior,
        Polymer.Templatizer
      ],

      /**
       * Fired when the stepper progress.
       *
       * @event paper-stepper-progressed
       */
      /**
       * Fired when all the steps are saved.
       *
       * @event paper-stepper-completed
       */
      properties: {
        alternativeLabel: {
          type: Boolean,
          value: false
        },
        vertical: {
          type: Boolean,
          value: false,
          notify: true,
          reflectToAttribute: true
        },
        completed: {
          type: Boolean,
          value: false,
          notify: true,
          computed: '_computeCompleted(stepNumber, savedStepNumber)'
        },
        stepNumber: {
          type: Number,
          notify: true,
          computed: '_computeStepNumber(items.length)'
        },
        savedStepNumber: {
          type: Number,
          notify: true,
          readOnly: true
        },
        selectedAttribute: {
          value: 'opened',
          readOnly: true
        },
        responsiveCheckFrequence: {
          type: Number,
          value: 200
        },
        _skipStepIndex: {
          type: Number,
          computed: '_compute_skipStepIndex(_selectedIndex)'
        },
        _canSkip: {
          type: Boolean,
          notify: true,
          computed: '_isntNull(_skipStepIndex)'
        },
        _backStepIndex: {
          type: Number,
          computed: '_compute_backStepIndex(_selectedIndex)'
        },
        _hasBackStep: {
          type: Boolean,
          computed: '_isntNull(_backStepIndex)'
        },
        _selectedIndex: {
          type: Number,
          readOnly: true,
          value: -1
        },
        activateEvent: {
          type: String,
          value: 'paper-step-select'
        },
        selectable: {
          type: String,
          value: 'paper-step'
        }
      },

      _handleHorizontalLabelsSelect: function(e) {
        this.selectIndex(this.indexOf(e.detail.item.step));
      },

      listeners:Â {
        'iron-items-changed': '_ironItemsChanged',
        'paper-step-saved': '_stepSaved',
        'paper-step-unsaved': '_stepUnsaved',
        'iron-resize': '_resizeHandler',
        'paper-stepper-forward': 'skip',
        'paper-stepper-back': 'back',
        'paper-stepper-continue': 'continue',
      },

      observers: [
        '_verticalChanged(vertical)',
      ],

      attached: function() {
        this._responsiveCheck();
      },

      /**
       * Missing Doc
       */
      back: function() {
        this.selectIndex(this._backStepIndex);
      },

      /**
       * @return {Boolean} Try to continue the current step (if no step opened, use the first one).
       */
      continue: function() {
        if (this.selectedItem) {
          if (this.selectedItem.save()) {
            this.progress();
          }
        }
      },

      /**
       * Loops around the steps from the current (if no step opened, from the first one)
       * in order to open the next selectable unsaved step. Returns true if a step has been opened.
       */
      progress: function() {
        if (!this.stepNumber) {
          return false;
        }
        if (this.completed) {
          this.selected = null;
          return true;
        }
        for (var i = (this._selectedIndex+1)%this.stepNumber; i != this._selectedIndex; i = (i+1)%this.stepNumber) {
          if (this.items[i].selectable && !this.items[i].saved) {
            this.selectIndex(i);
            this.fire('paper-stepper-progressed');
            return true;
          }
        }
        return false;
      },

      /* Deselect and set the steps as unsaved*/
      reset: function() {
        this._setSavedStepNumber(0);
        this.selected = null;
        if (!this.items.length) {
          return;
        }
        this.items.map(function(step) {
          step.saved = false;
        });
      },

      /**
       * Work around: Override the method from IronSelectableBehavior to only allow the selection of selectable step. https://github.com/PolymerElements/iron-selector/issues/99
       */
      // _selectSelected: function(selected) {
      //   var item = this._valueToItem(this.selected);
      //   if (item) {
      //     var selectable = item.selectable;
      //     if (selectable == undefined) {
      //       // if selectable isn't define it means the step is not yet ready for selection
      //       // and this method will be recalled by the initialization method.
      //       return;
      //     } else if (!selectable) {
      //       //reset previous selected if non null and selectable or deselect
      //       if (this._previousSelected && this._previousSelected.selectable) {
      //         this.selected = this._valueForItem(this.previousSelected);
      //       } else {
      //         this.selected = null;
      //       }
      //       this._previousSelected = null;
      //       return;
      //     }
      //   }
      //   this._selection.select(item);
      //   this._previousSelected = item;
      //   this._set_selectedIndex(this.indexOf(item));
      //   // Check for items, since this array is populated only when attached
      //   // Since Number(0) is falsy, explicitly check for undefined
      //   if (this.fallbackSelection && this.items.length && (this._selection.get() === undefined)) {
      //     this.selected = this.fallbackSelection;
      //   }
      // },

      _stepSaved: function(e) {
        this._setSavedStepNumber(this.savedStepNumber+1);
      },

      _stepUnsaved: function(e) {
        this._setSavedStepNumber(this.savedStepNumber-1);
      },

      _ensureHorizontalStepsContainerPopulated() {
        if (!this.horizontalStepContainer) {
          // TODO: only populate if needed
          // TODO: add Polymer 2 support
          var stepsContainerTemplate = this.getContentChildren('#horizontalStepsContainerTemplateSlot')[0];
          // TODO: check for template to be valid
          this.templatize(stepsContainerTemplate);
          this.horizontalStepContainer = this.stamp();
          // this.horizontalStepContainer._nodes[0] is the first node of the template, what's the better way to get it ?
          Polymer.dom(this.root).appendChild(this.horizontalStepContainer.root);
        }
        Polymer.dom(this.horizontalStepContainer._nodes[0]).appendChild(this.$.stepsSlot);
      },

      _ensureVertcalStepsContainerPopulated() {
        // this.items.forEach(function(step, i) {
        //   step.setAttribute('slot', 'vertical-step-' + i);
        //   console.log(step);
        // })
      },

      _verticalChanged: function(vertical) {
        if (!vertical) {
          this._ensureHorizontalStepsContainerPopulated();
          this.items.forEach(function(step, i) {
            step.removeAttribute('slot');
          })
        } else {
          this._ensureVertcalStepsContainerPopulated();
          var verticalStepsContainer = this.$.verticalStepsContainer;
          this.items.forEach(function(step, i) {
            // TODO: this should not be here
            step._setIndex(++i);
            verticalStepsContainer.prepareStepInsertion(step);
          }.bind(this))
          Polymer.dom(verticalStepsContainer).appendChild(this.$.stepsSlot);
        }

        if (this.stepNumber) {
          this.items.map(function(step) {
            step._setVertical(vertical);
          }.bind(this));
        }
      },

      //TODO: create a method for getContentChildren

      createSlot: function(name) {
        var slot;
        if (Polymer.Element) {
          slot = document.createElement('slot');
          if (name) slot.setAttribute('name', name);
        } else {
          slot = document.createElement('content');
          if (name) slot.setAttribute('select', "[slot='" + name + "']");
        }
        return slot;
      },

      _computeStepNumber: function(length) {
        return length;
      },

      _ironItemsChanged: function(e) {

        if (Polymer.dom(e).rootTarget != this) return;

        var horizontalLabelsContainer = this.$.horizontalLabelsContainer;
        var horizontalStepLabelTemplate = this.getContentChildren('#horizontalStepLabelTemplateSlot')[0];
        this.templatize(horizontalStepLabelTemplate);

        this.items.forEach(function(step, i) {
          step._setIndex(i + 1);
          step._setVertical(this.vertical);
          // true for index 0
          if (step.saved) {
            savedStepNumber++;
          }

          step.labelElement = this.stamp({step: step});
          Polymer.dom(horizontalLabelsContainer).appendChild(step.labelElement.root);
        }.bind(this));

        var verticalLabelsContainer = this.$.verticalStepsContainer;
        var verticalStepLabelTemplate = this.getContentChildren('#verticalStepLabelTemplateSlot')[0];
        this.templatize(verticalStepLabelTemplate);

        this.items.forEach(function(step, i) {
          step.verticalLabelElement = this.stamp({step: step});
          Polymer.dom(verticalLabelsContainer).appendChild(step.verticalLabelElement.root);
          step.verticalLabelElement._nodes[0].style.order = i*2;
        }.bind(this));

        var savedStepNumber = 0;
        var data = {
          linear: this.linear,
          stepNumber: this.stepNumber
        };

        this._setSavedStepNumber(savedStepNumber);
        // method from IronSelectableBehavior
        // this._updateSelected();
      },

      _compute_skipStepIndex: function(_selectedIndex) {
        if (_selectedIndex >= 0 && !this.completed) {
          for (var i=(_selectedIndex+1)%this.stepNumber; i!=_selectedIndex; i=(i+1)%this.stepNumber) {
            if (this.items[i].selectable && !this.items[i].saved) {
              return i;
            }
          }
        }
        return null;
      },

      _compute_backStepIndex: function(_selectedIndex) {
        if (_selectedIndex >= 0) {
          for (var i=_selectedIndex - 1; i >= 0; i--) {
            if (this.items[i].selectable) {
              return i;
            }
          }
        }
        return null
      },

      _isntNull: function(n) {
        return n != null;
      },

      _computeCompleted: function(savedStepNumber, stepNumber) {
        var completed = stepNumber == savedStepNumber;
        if (completed) {
          this.fire('paper-stepper-completed');
          return true;
        }
        return false;
      },

      _resizeHandler: function() {
        this.debounce('paper-stepper-responsive-check', function() {
          this._responsiveCheck();
        }, this.responsiveCheckFrequence);
      },

      _responsiveCheck: function() {
        var verticalResponsiveWidth = this.$.verticalResponsiveWidth.clientWidth;
        if (verticalResponsiveWidth) {
          this.vertical = !(this.clientWidth > verticalResponsiveWidth);
        }
      }

    });

  </script>
</dom-module>
